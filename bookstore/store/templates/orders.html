{% extends 'bookstore/base.html' %}

{% block title %}My Orders - Bookstore{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-bag-check"></i> My Orders</h2>
    </div>
</div>

<div id="ordersContent">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadOrders() {
    const token = getToken();
    if (!token) {
        document.getElementById('ordersContent').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> 
                Please <a href="/bookstore/login">login</a> to view your orders.
            </div>
        `;
        return;
    }
    
    fetch('/bookstore/api/orders/', {
        headers: {
            'Authorization': 'Token ' + token
        }
    })
    .then(response => response.json())
    .then(orders => {
        displayOrders(orders);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('ordersContent').innerHTML = `
            <div class="alert alert-danger">Error loading orders. Please try again.</div>
        `;
    });
}

function displayOrders(orders) {
    if (orders.length === 0) {
        document.getElementById('ordersContent').innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> You don't have any orders yet.
                <a href="/bookstore/books" class="alert-link">Start shopping!</a>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    orders.forEach(order => {
        const statusBadge = getStatusBadge(order.status);
        const date = new Date(order.created_at).toLocaleDateString();
        
        html += `
            <div class="col-md-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">Order #${order.id}</h5>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> ${date}
                                    </small>
                                </p>
                                <p class="mb-1">
                                    <strong>Items:</strong> ${order.items.length}
                                </p>
                                <p class="mb-1">
                                    <strong>Shipping:</strong> ${order.shipping_details ? order.shipping_details.method_name : 'N/A'}
                                </p>
                                <p class="mb-1">
                                    <strong>Payment:</strong> ${order.payment_details ? order.payment_details.method_name : 'N/A'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <h4 class="text-primary">${parseFloat(order.total_price).toLocaleString()}đ</h4>
                                <span class="badge ${statusBadge.class} mb-2">${statusBadge.text}</span>
                                <br>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetail(${order.id})">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                                ${order.status === 'pending' || order.status === 'confirmed' ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.id})">
                                        <i class="bi bi-x-circle"></i> Cancel
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('ordersContent').innerHTML = html;
}

function getStatusBadge(status) {
    const badges = {
        'pending': { class: 'bg-warning', text: 'Pending' },
        'confirmed': { class: 'bg-info', text: 'Confirmed' },
        'processing': { class: 'bg-primary', text: 'Processing' },
        'shipped': { class: 'bg-secondary', text: 'Shipped' },
        'delivered': { class: 'bg-success', text: 'Delivered' },
        'cancelled': { class: 'bg-danger', text: 'Cancelled' }
    };
    return badges[status] || { class: 'bg-secondary', text: status };
}

function viewOrderDetail(orderId) {
    const token = getToken();
    
    fetch(`/bookstore/api/orders/${orderId}/`, {
        headers: {
            'Authorization': 'Token ' + token
        }
    })
    .then(response => response.json())
    .then(order => {
        displayOrderDetail(order);
        new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading order details');
    });
}

function displayOrderDetail(order) {
    const statusBadge = getStatusBadge(order.status);
    const date = new Date(order.created_at).toLocaleDateString();
    
    let itemsHtml = '';
    order.items.forEach(item => {
        itemsHtml += `
            <tr>
                <td>${item.book_title}</td>
                <td>${item.book_author}</td>
                <td>${item.quantity}</td>
                <td>${parseFloat(item.price).toLocaleString()}đ</td>
                <td><strong>${parseFloat(item.subtotal).toLocaleString()}đ</strong></td>
            </tr>
        `;
    });
    
    const html = `
        <div class="order-detail">
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order ID:</strong> #${order.id}</p>
                    <p><strong>Date:</strong> ${date}</p>
                    <p><strong>Status:</strong> <span class="badge ${statusBadge.class}">${statusBadge.text}</span></p>
                </div>
                <div class="col-md-6">
                    <h6>Shipping Information</h6>
                    <p><strong>Method:</strong> ${order.shipping_details.method_name}</p>
                    <p><strong>Fee:</strong> ${parseFloat(order.shipping_details.fee).toLocaleString()}đ</p>
                    <p><strong>Address:</strong> ${order.shipping_address}</p>
                    ${order.note ? `<p><strong>Note:</strong> ${order.note}</p>` : ''}
                </div>
            </div>
            
            <h6>Order Items</h6>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Book</th>
                        <th>Author</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHtml}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Shipping Fee:</strong></td>
                        <td><strong>${parseFloat(order.shipping_details.fee).toLocaleString()}đ</strong></td>
                    </tr>
                    <tr class="table-primary">
                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                        <td><strong>${parseFloat(order.total_price).toLocaleString()}đ</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    document.getElementById('orderDetailContent').innerHTML = html;
}

function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) {
        return;
    }
    
    const token = getToken();
    
    fetch(`/bookstore/api/orders/${orderId}/cancel/`, {
        method: 'POST',
        headers: {
            'Authorization': 'Token ' + token
        }
    })
    .then(response => response.json())
    .then(data => {
        alert('Order cancelled successfully');
        loadOrders();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error cancelling order');
    });
}

// Load orders on page load
document.addEventListener('DOMContentLoaded', loadOrders);
</script>
{% endblock %}
