{% extends 'bookstore/base.html' %}

{% block title %}Checkout - Bookstore{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-credit-card"></i> Checkout</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Shipping Information</h5>
            </div>
            <div class="card-body">
                <form id="checkoutForm">
                    <div class="mb-3">
                        <label for="shippingAddress" class="form-label">Shipping Address *</label>
                        <textarea class="form-control" id="shippingAddress" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shippingMethod" class="form-label">Shipping Method *</label>
                        <select class="form-select" id="shippingMethod" required>
                            <option value="">Loading shipping methods...</option>
                        </select>
                        <div id="shippingInfo" class="form-text"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method *</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="">Select payment method</option>
                            <option value="Cash on Delivery">Cash on Delivery (COD)</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="E-Wallet">E-Wallet (Momo/ZaloPay)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="note" class="form-label">Note (Optional)</label>
                        <textarea class="form-control" id="note" rows="2" placeholder="Add any special instructions"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Order Summary</h5>
            </div>
            <div class="card-body">
                <div id="orderSummary">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    </div>
                </div>
                <hr>
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" onclick="placeOrder()">
                        <i class="bi bi-check-circle"></i> Place Order
                    </button>
                </div>
                <div class="text-center mt-2">
                    <a href="/bookstore/cart" class="text-muted small">
                        <i class="bi bi-arrow-left"></i> Back to Cart
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Order Placed Successfully!</h5>
            </div>
            <div class="modal-body text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                <h4 class="mt-3">Thank you for your order!</h4>
                <p class="text-muted">Order ID: <strong id="orderIdDisplay"></strong></p>
                <p>You can track your order in the Orders page.</p>
            </div>
            <div class="modal-footer">
                <a href="/bookstore/orders" class="btn btn-primary">View Orders</a>
                <a href="/bookstore/books" class="btn btn-outline-secondary">Continue Shopping</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cart = null;
let shippingMethods = [];
let selectedShipping = null;

function loadShippingMethods() {
    const token = getToken();
    
    fetch('/bookstore/api/orders/shipping/', {
        headers: {
            'Authorization': 'Token ' + token
        }
    })
    .then(response => response.json())
    .then(data => {
        shippingMethods = data;
        displayShippingMethods(data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function displayShippingMethods(methods) {
    const select = document.getElementById('shippingMethod');
    select.innerHTML = '<option value="">Select shipping method</option>';
    
    methods.forEach(method => {
        const option = document.createElement('option');
        option.value = method.id;
        option.textContent = `${method.method_name} - ${parseFloat(method.fee).toLocaleString()} (${method.estimated_days} days)`;
        option.dataset.fee = method.fee;
        option.dataset.description = method.description;
        select.appendChild(option);
    });
    
    select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const description = selectedOption.dataset.description;
            document.getElementById('shippingInfo').textContent = description;
            selectedShipping = shippingMethods.find(m => m.id == selectedOption.value);
            updateOrderSummary();
        }
    });
}

function loadCart() {
    const token = getToken();
    if (!token) {
        window.location.href = '/bookstore/login';
        return;
    }
    
    fetch('/bookstore/api/cart/', {
        headers: {
            'Authorization': 'Token ' + token
        }
    })
    .then(response => response.json())
    .then(data => {
        cart = data;
        if (!cart.items || cart.items.length === 0) {
            alert('Your cart is empty!');
            window.location.href = '/bookstore/cart';
            return;
        }
        updateOrderSummary();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading cart');
        window.location.href = '/bookstore/cart';
    });
}

function updateOrderSummary() {
    if (!cart || !cart.items) return;
    
    let subtotal = 0;
    cart.items.forEach(item => {
        subtotal += parseFloat(item.subtotal);
    });
    
    const shippingFee = selectedShipping ? parseFloat(selectedShipping.fee) : 0;
    const total = subtotal + shippingFee;
    
    let html = `
        <div class="mb-2">
            <div class="d-flex justify-content-between">
                <span>Items (${cart.items.length}):</span>
                <span>${subtotal.toLocaleString()}</span>
            </div>
        </div>
        <div class="mb-2">
            <div class="d-flex justify-content-between">
                <span>Shipping:</span>
                <span>${shippingFee > 0 ? shippingFee.toLocaleString() + '' : 'Select method'}</span>
            </div>
        </div>
        <hr>
        <div class="mb-2">
            <div class="d-flex justify-content-between">
                <strong>Total:</strong>
                <strong class="text-primary">${total.toLocaleString()}</strong>
            </div>
        </div>
    `;
    
    document.getElementById('orderSummary').innerHTML = html;
}

function placeOrder() {
    const shippingAddress = document.getElementById('shippingAddress').value.trim();
    const shippingMethodId = document.getElementById('shippingMethod').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const note = document.getElementById('note').value.trim();
    
    if (!shippingAddress) {
        alert('Please enter shipping address');
        return;
    }
    
    if (!shippingMethodId) {
        alert('Please select shipping method');
        return;
    }
    
    if (!paymentMethod) {
        alert('Please select payment method');
        return;
    }
    
    const token = getToken();
    const orderData = {
        shipping_id: parseInt(shippingMethodId),
        payment_method: paymentMethod,
        shipping_address: shippingAddress,
        note: note
    };
    
    // Disable button
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
    
    fetch('/bookstore/api/orders/', {
        method: 'POST',
        headers: {
            'Authorization': 'Token ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(orderData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                console.error('Server error response:', err);
                return Promise.reject(err);
            }).catch(jsonErr => {
                // If response is not JSON, return text
                return response.text().then(text => {
                    console.error('Server error text:', text);
                    return Promise.reject({ error: text || 'Server error' });
                });
            });
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('orderIdDisplay').textContent = '#' + data.id;
        new bootstrap.Modal(document.getElementById('successModal')).show();
    })
    .catch(error => {
        console.error('Error details:', error);
        let errorMessage = 'Please try again';
        if (typeof error === 'object' && error.error) {
            errorMessage = error.error;
        } else if (typeof error === 'string') {
            errorMessage = error;
        }
        alert('Error placing order: ' + errorMessage);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Place Order';
    });
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCart();
    loadShippingMethods();
    
    // Load customer info if available
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.customer && user.customer.address) {
        document.getElementById('shippingAddress').value = user.customer.address;
    }
});
</script>
{% endblock %}
