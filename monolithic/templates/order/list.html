{% extends 'base.html' %}

{% block title %}L·ªãch s·ª≠ ƒë∆°n h√†ng{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">üìã L·ªãch s·ª≠ ƒë∆°n h√†ng</h2>

<div id="alert-container"></div>
<div id="ordersContainer"></div>

<script>
let currentUser = null;

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || user.type !== 'customer') {
        window.location.href = '/web/login/';
        return null;
    }
    currentUser = user;
    return user;
}

// T·∫£i danh s√°ch ƒë∆°n h√†ng
async function loadOrders() {
    const user = checkAuth();
    if (!user) return;
    
    try {
        const response = await fetch(`/api/orders/customer/${user.id}/`);
        const data = await response.json();
        
        if (data.success) {
            renderOrders(data.orders);
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Load orders error:', error);
    }
}

// Render danh s√°ch ƒë∆°n h√†ng
function renderOrders(orders) {
    const container = document.getElementById('ordersContainer');
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. <a href="/web/">Mua s·∫Øm ngay!</a>
            </div>
        `;
        return;
    }
    
    const statusColors = {
        'Delivered': { bg: '#d4edda', text: '#155724' },
        'Pending': { bg: '#fff3cd', text: '#856404' },
        'Shipping': { bg: '#d1ecf1', text: '#0c5460' }
    };
    
    container.innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>M√£ ƒë∆°n</th>
                        <th>Ng√†y ƒë·∫∑t</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Giao h√†ng</th>
                        <th>Thanh to√°n</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    ${orders.map(order => {
                        const colors = statusColors[order.status] || { bg: '#d1ecf1', text: '#0c5460' };
                        const date = new Date(order.order_date);
                        const formattedDate = date.toLocaleDateString('vi-VN');
                        
                        return `
                            <tr>
                                <td><strong>#${order.id}</strong></td>
                                <td>${formattedDate}</td>
                                <td><strong>$${order.total_price}</strong></td>
                                <td>
                                    <span style="padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.9rem;
                                                 background: ${colors.bg};
                                                 color: ${colors.text};">
                                        ${order.status}
                                    </span>
                                </td>
                                <td>${order.shipping_method}</td>
                                <td>${order.payment_method}</td>
                                <td>
                                    <a href="/web/orders/${order.id}/" class="btn btn-secondary" style="padding: 0.3rem 1rem;">
                                        Chi ti·∫øt
                                    </a>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

// Kh·ªüi t·∫°o
loadOrders();
</script>
{% endblock %}
