{% extends 'base.html' %}

{% block title %}Chi ti·∫øt ƒë∆°n h√†ng{% endblock %}

{% block content %}
<a href="#" id="backButton" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Quay l·∫°i</a>

<h2 id="orderTitle" style="margin-bottom: 1.5rem;">üì¶ Chi ti·∫øt ƒë∆°n h√†ng</h2>

<div id="alert-container"></div>
<div id="orderDetailContainer"></div>

<script>
const orderId = parseInt(window.location.pathname.split('/')[3]);
let currentUser = null;

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || (user.type !== 'customer' && user.type !== 'staff')) {
        window.location.href = '/web/login/';
        return null;
    }
    currentUser = user;
    
    // Set back button URL based on user type
    const backButton = document.getElementById('backButton');
    if (user.type === 'staff') {
        backButton.href = '/web/staff/orders/';
    } else {
        backButton.href = '/web/orders/';
    }
    
    return user;
}

// T·∫£i chi ti·∫øt ƒë∆°n h√†ng
async function loadOrderDetail() {
    const user = checkAuth();
    if (!user) return;
    
    try {
        const response = await fetch(`/api/orders/${orderId}/`);
        const data = await response.json();
        
        if (data.success) {
            renderOrderDetail(data.order);
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Load order error:', error);
    }
}

// Render chi ti·∫øt ƒë∆°n h√†ng
function renderOrderDetail(order) {
    document.getElementById('orderTitle').textContent = `üì¶ Chi ti·∫øt ƒë∆°n h√†ng #${order.id}`;
    
    const statusColors = {
        'Delivered': { bg: '#d4edda', text: '#155724' },
        'Pending': { bg: '#fff3cd', text: '#856404' },
        'Shipping': { bg: '#d1ecf1', text: '#0c5460' }
    };
    
    const colors = statusColors[order.status] || { bg: '#d1ecf1', text: '#0c5460' };
    const date = new Date(order.order_date);
    const formattedDate = date.toLocaleDateString('vi-VN');
    
    const container = document.getElementById('orderDetailContainer');
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <!-- Order Items -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">S·∫£n ph·∫©m</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>S√°ch</th>
                                <th>Gi√°</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>
                                        <strong>${item.book_title}</strong><br>
                                        <small>${item.book_author}</small>
                                    </td>
                                    <td>$${item.price}</td>
                                    <td>${item.quantity}</td>
                                    <td><strong>$${item.subtotal}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div>
                <!-- Order Info -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Th√¥ng tin ƒë∆°n h√†ng</h3>
                    
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Ng√†y ƒë·∫∑t:</strong> ${formattedDate}
                    </p>
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Tr·∫°ng th√°i:</strong>
                        <span style="padding: 0.3rem 0.8rem; border-radius: 4px;
                                     background: ${colors.bg};
                                     color: ${colors.text};">
                            ${order.status}
                        </span>
                    </p>
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Nh√¢n vi√™n x·ª≠ l√Ω:</strong> ${order.staff.name}
                    </p>
                    
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
                    
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Giao h√†ng:</strong> ${order.shipping.method}
                    </p>
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Ph√≠ ship:</strong> $${order.shipping.fee}
                    </p>
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Thanh to√°n:</strong> ${order.payment.method}
                    </p>
                    <p style="margin-bottom: 0.8rem;">
                        <strong>Tr·∫°ng th√°i TT:</strong> ${order.payment.status}
                    </p>
                    
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
                    
                    <p style="font-size: 1.3rem; margin-top: 1rem;">
                        <strong>T·ªïng c·ªông:</strong> 
                        <strong style="color: #27ae60;">$${order.total_price}</strong>
                    </p>
                </div>
            </div>
        </div>
    `;
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

// Kh·ªüi t·∫°o
loadOrderDetail();
</script>
{% endblock %}
