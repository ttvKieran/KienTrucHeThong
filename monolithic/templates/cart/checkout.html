{% extends 'base.html' %}

{% block title %}Thanh to√°n{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">üí≥ Thanh to√°n ƒë∆°n h√†ng</h2>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Order Summary -->
    <div>
        <div class="card">
            <h3 style="margin-bottom: 1rem;">ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
            <table>
                <thead>
                    <tr>
                        <th>S√°ch</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                    <tr>
                        <td>{{ item.book.title }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>${{ item.book.price }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Shipping & Payment Form -->
        <div class="card" style="margin-top: 1rem;">
            <h3 style="margin-bottom: 1rem;">Th√¥ng tin giao h√†ng & thanh to√°n</h3>
            
            <form method="POST" action="{% url 'web_place_order' %}">
                {% csrf_token %}
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Ph∆∞∆°ng th·ª©c giao h√†ng:
                    </label>
                    {% for shipping in shipping_methods %}
                    <div style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="shipping_id" value="{{ shipping.id }}" 
                                   {% if forloop.first %}checked{% endif %}
                                   onchange="updateTotal({{ shipping.fee }})"
                                   style="margin-right: 0.5rem;">
                            <span style="flex: 1;">
                                <strong>{{ shipping.method_name }}</strong>
                            </span>
                            <span style="color: #27ae60;">+${{ shipping.fee }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Ph∆∞∆°ng th·ª©c thanh to√°n:
                    </label>
                    {% for payment in payment_methods %}
                    <div style="padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="payment_id" value="{{ payment.id }}" 
                                   {% if forloop.first %}checked{% endif %}
                                   style="margin-right: 0.5rem;">
                            <strong>{{ payment.method_name }}</strong>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                    ‚úÖ ƒê·∫∑t h√†ng
                </button>
            </form>
        </div>
    </div>
    
    <!-- Price Summary -->
    <div>
        <div class="card">
            <h3 style="margin-bottom: 1rem;">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
            <div style="padding: 1rem 0; border-bottom: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>T·∫°m t√≠nh:</span>
                    <span id="subtotal">${{ subtotal }}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Ph√≠ ship:</span>
                    <span id="shipping-fee">${{ shipping_methods.0.fee|default:"0.00" }}</span>
                </div>
            </div>
            <div style="padding: 1rem 0;">
                <div style="display: flex; justify-content: space-between; font-size: 1.3rem;">
                    <strong>T·ªïng c·ªông:</strong>
                    <strong id="total" style="color: #27ae60;">${{ subtotal }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const subtotal = {{ subtotal }};
    
    function updateTotal(shippingFee) {
        const total = subtotal + parseFloat(shippingFee);
        document.getElementById('shipping-fee').textContent = '$' + shippingFee.toFixed(2);
        document.getElementById('total').textContent = '$' + total.toFixed(2);
    }
    
    // Set initial total
    const firstShipping = document.querySelector('input[name="shipping_id"]:checked');
    if (firstShipping) {
        const fee = {{ shipping_methods.0.fee|default:"0" }};
        updateTotal(fee);
    }
</script>
{% endblock %}
