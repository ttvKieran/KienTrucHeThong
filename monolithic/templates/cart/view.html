{% extends 'base.html' %}

{% block title %}Gi·ªè h√†ng{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<div id="alert-container"></div>
<div id="cartContainer"></div>

<script>
let currentUser = null;
let cartData = null;

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || user.type !== 'customer') {
        window.location.href = '/web/login/';
        return null;
    }
    currentUser = user;
    return user;
}

// T·∫£i gi·ªè h√†ng
async function loadCart() {
    const user = checkAuth();
    if (!user) return;
    
    try {
        const response = await fetch(`/api/cart/${user.id}/`);
        const data = await response.json();
        
        if (data.success) {
            cartData = data.cart;
            renderCart(data.cart);
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Load cart error:', error);
    }
}

// Render gi·ªè h√†ng
function renderCart(cart) {
    const container = document.getElementById('cartContainer');
    
    if (!cart.items || cart.items.length === 0) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Gi·ªè h√†ng tr·ªëng. <a href="/web/">Mua s·∫Øm ngay!</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>S√°ch</th>
                        <th>Gi√°</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>T·ªïng</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    ${cart.items.map(item => `
                        <tr>
                            <td>
                                <strong>${item.book_title}</strong><br>
                                <small style="color: #7f8c8d;">${item.book_author}</small>
                            </td>
                            <td>$${item.book_price}</td>
                            <td>
                                <input type="number" id="qty_${item.id}" value="${item.quantity}" min="1" 
                                       max="${item.book_stock}" 
                                       style="width: 60px; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="updateCartItem(${item.id})">
                            </td>
                            <td><strong>$${item.subtotal}</strong></td>
                            <td>
                                <button onclick="removeCartItem(${item.id})" class="btn btn-danger" style="padding: 0.3rem 1rem;">X√≥a</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right;"><strong>T·ªïng c·ªông:</strong></td>
                        <td><strong style="color: #27ae60; font-size: 1.2rem;">$${cart.total}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            
            <div style="margin-top: 2rem; display: flex; justify-content: space-between;">
                <a href="/web/" class="btn btn-secondary">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
                <a href="/web/checkout/" class="btn btn-success">Thanh to√°n ‚Üí</a>
            </div>
        </div>
    `;
}

// C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
async function updateCartItem(itemId) {
    const quantity = parseInt(document.getElementById(`qty_${itemId}`).value);
    
    try {
        const response = await fetch('/api/cart/update/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: quantity
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadCart(); // Reload cart
            showAlert('ƒê√£ c·∫≠p nh·∫≠t gi·ªè h√†ng!', 'success');
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Update cart error:', error);
    }
}

// X√≥a item
async function removeCartItem(itemId) {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;
    
    try {
        const response = await fetch('/api/cart/remove/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ item_id: itemId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadCart(); // Reload cart
            showAlert('ƒê√£ x√≥a kh·ªèi gi·ªè h√†ng!', 'success');
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ x√≥a!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Remove cart error:', error);
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => { alertContainer.innerHTML = ''; }, 3000);
}

// Kh·ªüi t·∫°o
loadCart();
</script>
{% endblock %}
