{% extends 'base.html' %}

{% block title %}G·ª£i √Ω s√°ch{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">üí° G·ª£i √Ω s√°ch d√†nh cho b·∫°n</h2>

<div id="alert-container"></div>

<!-- Top Rated Books -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">‚≠ê S√°ch ƒë∆∞·ª£c ƒë√°nh gi√° cao</h3>
    <div id="topRatedBooks" class="grid"></div>
</div>

<!-- Based on Purchase History -->
<div class="card" style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem;">üìö D·ª±a tr√™n l·ªãch s·ª≠ mua h√†ng c·ªßa b·∫°n</h3>
    <div id="historyBasedBooks" class="grid"></div>
</div>

<div style="margin-top: 2rem; text-align: center;">
    <a href="/web/" class="btn btn-success" style="padding: 1rem 2rem;">
        üõçÔ∏è Ti·∫øp t·ª•c mua s·∫Øm
    </a>
</div>

<script>
let currentUser = null;

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || user.type !== 'customer') {
        window.location.href = '/web/login/';
        return null;
    }
    currentUser = user;
    return user;
}

// T·∫£i s√°ch rating cao
async function loadTopRated() {
    try {
        const response = await fetch('/api/recommendations/by-rating/?limit=12');
        const data = await response.json();
        
        if (data.success && data.top_rated && data.top_rated.length > 0) {
            renderBooks(data.top_rated, 'topRatedBooks', true);
        } else {
            document.getElementById('topRatedBooks').innerHTML = '<p style="color: #7f8c8d;">Ch∆∞a c√≥ s√°ch n√†o ƒë∆∞·ª£c ƒë√°nh gi√°.</p>';
        }
    } catch (error) {
        console.error('Load top rated error:', error);
        document.getElementById('topRatedBooks').innerHTML = '<p style="color: #7f8c8d;">Ch∆∞a c√≥ s√°ch n√†o ƒë∆∞·ª£c ƒë√°nh gi√°.</p>';
    }
}

// T·∫£i s√°ch d·ª±a tr√™n l·ªãch s·ª≠
async function loadHistoryBased() {
    const user = checkAuth();
    if (!user) return;
    
    try {
        const response = await fetch(`/api/recommendations/by-history/${user.id}/?limit=12`);
        const data = await response.json();
        
        if (data.success && data.recommendations && data.recommendations.length > 0) {
            renderBooks(data.recommendations, 'historyBasedBooks', false);
        } else {
            document.getElementById('historyBasedBooks').innerHTML = '<p style="color: #7f8c8d;">Ch∆∞a c√≥ g·ª£i √Ω d·ª±a tr√™n l·ªãch s·ª≠ mua h√†ng.</p>';
        }
    } catch (error) {
        console.error('Load history based error:', error);
        document.getElementById('historyBasedBooks').innerHTML = '<p style="color: #7f8c8d;">Ch∆∞a c√≥ g·ª£i √Ω d·ª±a tr√™n l·ªãch s·ª≠ mua h√†ng.</p>';
    }
}

// Render danh s√°ch s√°ch
function renderBooks(books, containerId, showRating) {
    const container = document.getElementById(containerId);
    
    container.innerHTML = books.map(book => `
        <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
            <h4 style="margin-bottom: 0.5rem;">${book.title}</h4>
            <p style="color: #7f8c8d; margin-bottom: 0.3rem;">${book.author}</p>
            <p style="color: #3498db; margin-bottom: 0.3rem;">${book.category_name}</p>
            ${showRating && book.average_rating > 0 ? `
                <p style="color: #f39c12; margin-bottom: 0.5rem;">
                    <strong>‚≠ê ${book.average_rating.toFixed(1)}/5.0</strong> 
                    ${book.total_ratings ? `(${book.total_ratings} ƒë√°nh gi√°)` : ''}
                </p>
            ` : ''}
            <p style="color: #27ae60; margin-bottom: 1rem;"><strong>$${book.price}</strong></p>
            <a href="/web/book/${book.id}/" class="btn" style="width: 100%; text-align: center;">
                Xem chi ti·∫øt
            </a>
        </div>
    `).join('');
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

// Kh·ªüi t·∫°o
checkAuth();
loadTopRated();
loadHistoryBased();
</script>
{% endblock %}
