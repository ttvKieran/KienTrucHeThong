{% extends 'base.html' %}

{% block title %}Danh s√°ch s√°ch{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">Danh s√°ch s√°ch</h2>

<div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
    <div style="display: flex; gap: 1rem; flex: 1;">
        <input type="text" id="searchQuery" placeholder="T√¨m ki·∫øm s√°ch, t√°c gi·∫£..."
               style="flex: 1; padding: 0.7rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
        
        <select id="categoryFilter" style="padding: 0.7rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
            <option value="">T·∫•t c·∫£ danh m·ª•c</option>
        </select>
        
        <button id="searchBtn" class="btn">üîç T√¨m ki·∫øm</button>
    </div>
</div>

<div id="alert-container"></div>
<div id="booksContainer" class="grid"></div>

<script>
let currentUser = null;

// T·∫£i danh s√°ch categories
async function loadCategories() {
    try {
        const response = await fetch('/api/books/categories/');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('categoryFilter');
            data.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Load categories error:', error);
    }
}

// T√¨m ki·∫øm s√°ch
async function searchBooks() {
    const query = document.getElementById('searchQuery').value;
    const category = document.getElementById('categoryFilter').value;
    
    let url = '/api/books/search/?';
    if (query) url += `q=${encodeURIComponent(query)}&`;
    if (category) url += `category=${category}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            renderBooks(data.books);
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s√°ch!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Search books error:', error);
    }
}

// Render danh s√°ch s√°ch
function renderBooks(books) {
    const container = document.getElementById('booksContainer');
    
    if (books.length === 0) {
        container.innerHTML = '<div class="alert alert-danger">Kh√¥ng t√¨m th·∫•y s√°ch n√†o.</div>';
        return;
    }
    
    container.innerHTML = books.map(book => `
        <div class="card">
            <h3 style="margin-bottom: 0.5rem; color: #2c3e50;">${book.title}</h3>
            <p style="color: #7f8c8d; margin-bottom: 0.5rem;">${book.author}</p>
            <p style="color: #3498db; margin-bottom: 0.5rem;"><strong>${book.category_name}</strong></p>
            <p style="font-size: 1.2rem; color: #27ae60; margin-bottom: 0.5rem;"><strong>$${book.price}</strong></p>
            <p style="color: ${book.stock_quantity > 10 ? '#27ae60' : book.stock_quantity > 0 ? '#e67e22' : '#e74c3c'}; margin-bottom: 1rem;">
                Kho: ${book.stock_quantity} cu·ªën
            </p>
            
            <div style="display: flex; gap: 0.5rem;">
                <a href="/web/book/${book.id}/" class="btn btn-secondary" style="flex: 1; text-align: center;">
                    Chi ti·∫øt
                </a>
                ${book.stock_quantity > 0 ? `
                    <button onclick="addToCart(${book.id})" class="btn btn-success" style="flex: 1;">+ Gi·ªè</button>
                ` : `
                    <button class="btn btn-danger" style="flex: 1;" disabled>H·∫øt h√†ng</button>
                `}
            </div>
        </div>
    `).join('');
}

// Th√™m v√†o gi·ªè h√†ng
async function addToCart(bookId) {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    
    if (!user || user.type !== 'customer') {
        showAlert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m v√†o gi·ªè h√†ng!', 'warning');
        setTimeout(() => window.location.href = '/web/login/', 1500);
        return;
    }
    
    try {
        const response = await fetch('/api/cart/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                customer_id: user.id,
                book_id: bookId,
                quantity: 1
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('ƒê√£ th√™m v√†o gi·ªè h√†ng!', 'success');
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Add to cart error:', error);
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => { alertContainer.innerHTML = ''; }, 3000);
}

// Kh·ªüi t·∫°o
document.getElementById('searchBtn').addEventListener('click', searchBooks);
document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchBooks();
});
document.getElementById('categoryFilter').addEventListener('change', searchBooks);

loadCategories();
searchBooks();
</script>
{% endblock %}
