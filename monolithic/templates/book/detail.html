{% extends 'base.html' %}

{% block title %}Chi ti·∫øt s√°ch{% endblock %}

{% block content %}
<a href="/web/" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Quay l·∫°i</a>

<div id="alert-container"></div>
<div id="bookDetail"></div>
<div id="ratingsSection" class="card" style="margin-top: 2rem;"></div>
<div id="similarBooksSection" class="card" style="margin-top: 2rem;"></div>

<script>
const bookId = parseInt(window.location.pathname.split('/')[3]);
let currentUser = null;

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    currentUser = user;
    return user;
}

// T·∫£i chi ti·∫øt s√°ch
async function loadBookDetail() {
    try {
        const response = await fetch(`/api/books/${bookId}/`);
        const data = await response.json();
        
        if (data.success) {
            renderBookDetail(data.book);
            loadRatings();
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s√°ch!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Load book error:', error);
    }
}

// Render chi ti·∫øt s√°ch
function renderBookDetail(book) {
    const container = document.getElementById('bookDetail');
    const stockColor = book.stock_quantity > 10 ? '#27ae60' : book.stock_quantity > 0 ? '#e67e22' : '#e74c3c';
    
    container.innerHTML = `
        <div class="card">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                <div style="background: #ecf0f1; height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                    <span style="font-size: 4rem;">üìñ</span>
                </div>
                
                <div>
                    <h2 style="margin-bottom: 1rem; color: #2c3e50;">${book.title}</h2>
                    <p style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 1rem;">
                        <strong>T√°c gi·∫£:</strong> ${book.author}
                    </p>
                    <p style="margin-bottom: 1rem;">
                        <strong>Danh m·ª•c:</strong> 
                        <span style="background: #3498db; color: white; padding: 0.3rem 0.8rem; border-radius: 4px;">
                            ${book.category_name}
                        </span>
                    </p>
                    <p style="font-size: 1.5rem; color: #27ae60; margin-bottom: 1rem;">
                        <strong>Gi√°: $${book.price}</strong>
                    </p>
                    <p style="margin-bottom: 1rem; color: ${stockColor};">
                        <strong>T·ªìn kho:</strong> ${book.stock_quantity} cu·ªën
                    </p>
                    
                    <div style="margin-top: 2rem;">
                        ${book.stock_quantity > 0 ? `
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <label>S·ªë l∆∞·ª£ng:</label>
                                <input type="number" id="quantity" value="1" min="1" max="${book.stock_quantity}" 
                                       style="width: 80px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="addToCart()" class="btn btn-success">üõí Th√™m v√†o gi·ªè</button>
                            </div>
                        ` : `
                            <button class="btn btn-danger" disabled>H·∫øt h√†ng</button>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// T·∫£i ƒë√°nh gi√°
async function loadRatings() {
    try {
        const response = await fetch(`/api/books/${bookId}/ratings/`);
        const data = await response.json();
        
        if (data.success) {
            renderRatings(data.ratings, data.average_rating);
        }
    } catch (error) {
        console.error('Load ratings error:', error);
    }
}

// Render ƒë√°nh gi√°
function renderRatings(ratings, avgRating) {
    const container = document.getElementById('ratingsSection');
    
    let html = '<h3 style="margin-bottom: 1rem;">ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h3>';
    
    if (avgRating) {
        html += `<p style="margin-bottom: 1rem; color: #f39c12;">
            <strong>‚≠ê ƒê√°nh gi√° trung b√¨nh:</strong> ${avgRating.toFixed(1)}/5.0 (${ratings.length} ƒë√°nh gi√°)
        </p>`;
    }
    
    if (ratings.length > 0) {
        html += ratings.map(r => `
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${r.customer_name}</strong> - <span style="color: #f39c12;">‚≠ê ${r.score}/5.0</span>
            </div>
        `).join('');
    } else {
        html += '<p style="color: #7f8c8d;">Ch∆∞a c√≥ ƒë√°nh gi√°.</p>';
    }
    
    container.innerHTML = html;
}

// Th√™m v√†o gi·ªè h√†ng
async function addToCart() {
    const user = checkAuth();
    
    if (!user || user.type !== 'customer') {
        showAlert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m v√†o gi·ªè h√†ng!', 'warning');
        setTimeout(() => window.location.href = '/web/login/', 1500);
        return;
    }
    
    const quantity = parseInt(document.getElementById('quantity').value);
    
    try {
        const response = await fetch('/api/cart/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                customer_id: user.id,
                book_id: bookId,
                quantity: quantity
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(`ƒê√£ th√™m ${quantity} cu·ªën v√†o gi·ªè h√†ng!`, 'success');
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Add to cart error:', error);
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => { alertContainer.innerHTML = ''; }, 3000);
}

// Kh·ªüi t·∫°o
checkAuth();
loadBookDetail();
</script>
{% endblock %}
