{% extends 'base.html' %}

{% block title %}Qu·∫£n l√Ω kho - Staff Dashboard{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">üë®‚Äçüíº Qu·∫£n l√Ω kho h√†ng</h2>

<div id="alert-container"></div>

<!-- Add New Book -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">‚ûï Th√™m s√°ch m·ªõi</h3>
    <form id="addBookForm">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.3rem;">T√™n s√°ch:</label>
                <input type="text" id="title" name="title" required 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.3rem;">T√°c gi·∫£:</label>
                <input type="text" id="author" name="author" required 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.3rem;">Gi√° ($):</label>
                <input type="number" id="price" name="price" step="0.01" required 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.3rem;">S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="stock_quantity" name="stock_quantity" required 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.3rem;">Danh m·ª•c:</label>
                <select id="category_id" name="category_id" required 
                        style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn btn-success" style="width: 100%;">Th√™m s√°ch</button>
            </div>
        </div>
    </form>
</div>

<!-- Books Inventory -->
<div class="card" style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem;">üìö Kho s√°ch hi·ªán t·∫°i</h3>
    <div id="booksInventory"></div>
</div>

<script>
let currentUser = null;
let categories = [];
let books = [];

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || user.type !== 'staff') {
        window.location.href = '/web/login/';
        return null;
    }
    currentUser = user;
    return user;
}

// T·∫£i danh m·ª•c
async function loadCategories() {
    try {
        const response = await fetch('/api/books/categories/');
        const data = await response.json();
        
        if (data.success) {
            categories = data.categories;
            const select = document.getElementById('category_id');
            select.innerHTML = data.categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
        }
    } catch (error) {
        console.error('Load categories error:', error);
    }
}

// T·∫£i danh s√°ch s√°ch
async function loadBooks() {
    try {
        const response = await fetch('/api/books/');
        const data = await response.json();
        
        if (data.success) {
            books = data.books;
            renderBooksInventory(data.books);
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s√°ch!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Load books error:', error);
    }
}

// Render b·∫£ng kho s√°ch
function renderBooksInventory(booksList) {
    const container = document.getElementById('booksInventory');
    
    // Ki·ªÉm tra low stock
    const lowStockCount = booksList.filter(b => b.stock_quantity < 10).length;
    if (lowStockCount > 0) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger';
        alertDiv.style.marginBottom = '1rem';
        alertDiv.innerHTML = `<strong>‚ö†Ô∏è C·∫£nh b√°o:</strong> C√≥ ${lowStockCount} s√°ch s·∫Øp h·∫øt h√†ng (< 10 cu·ªën)`;
        container.parentElement.insertBefore(alertDiv, container);
    }
    
    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n s√°ch</th>
                    <th>T√°c gi·∫£</th>
                    <th>Danh m·ª•c</th>
                    <th>Gi√°</th>
                    <th>T·ªìn kho</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                ${booksList.map(book => `
                    <tr style="${book.stock_quantity < 10 ? 'background: #fff3cd;' : ''}">
                        <td>${book.id}</td>
                        <td><strong>${book.title}</strong></td>
                        <td>${book.author}</td>
                        <td>${book.category_name}</td>
                        <td>$${book.price}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" id="stock_${book.id}" value="${book.stock_quantity}" min="0"
                                       style="width: 70px; padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="updateStock(${book.id})" class="btn" style="padding: 0.3rem 0.8rem;">üíæ</button>
                            </div>
                        </td>
                        <td>
                            <button onclick="deleteBook(${book.id})" class="btn btn-danger" style="padding: 0.3rem 0.8rem;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Th√™m s√°ch m·ªõi
document.getElementById('addBookForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const user = checkAuth();
    if (!user) return;
    
    const formData = {
        staff_id: user.id,
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        price: parseFloat(document.getElementById('price').value),
        stock_quantity: parseInt(document.getElementById('stock_quantity').value),
        category_id: parseInt(document.getElementById('category_id').value)
    };
    
    try {
        const response = await fetch('/api/staff/books/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('ƒê√£ th√™m s√°ch m·ªõi th√†nh c√¥ng!', 'success');
            document.getElementById('addBookForm').reset();
            loadBooks(); // Reload inventory
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ th√™m s√°ch!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Add book error:', error);
    }
});

// C·∫≠p nh·∫≠t t·ªìn kho
async function updateStock(bookId) {
    const user = checkAuth();
    if (!user) return;
    
    const stock_quantity = parseInt(document.getElementById(`stock_${bookId}`).value);
    
    try {
        const response = await fetch(`/api/staff/books/${bookId}/stock/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                staff_id: user.id,
                stock_quantity: stock_quantity
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('ƒê√£ c·∫≠p nh·∫≠t t·ªìn kho!', 'success');
            loadBooks(); // Reload inventory
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Update stock error:', error);
    }
}

// X√≥a s√°ch
async function deleteBook(bookId) {
    if (!confirm('X√°c nh·∫≠n x√≥a s√°ch n√†y?')) return;
    
    const user = checkAuth();
    if (!user) return;
    
    try {
        const response = await fetch(`/api/staff/books/${bookId}/delete/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                staff_id: user.id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('ƒê√£ x√≥a s√°ch!', 'success');
            loadBooks(); // Reload inventory
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ x√≥a!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Delete book error:', error);
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => { alertContainer.innerHTML = ''; }, 3000);
}

// Kh·ªüi t·∫°o
checkAuth();
loadCategories();
loadBooks();
</script>
{% endblock %}
