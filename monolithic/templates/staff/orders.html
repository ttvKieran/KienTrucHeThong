{% extends 'base.html' %}

{% block title %}Qu·∫£n l√Ω ƒë∆°n h√†ng{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>

<div id="alert-container"></div>

<!-- Filter by status -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; gap: 1rem; align-items: center;">
        <label style="font-weight: bold;">L·ªçc theo tr·∫°ng th√°i:</label>
        <select id="statusFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; flex: 1; max-width: 300px;">
            <option value="">T·∫•t c·∫£</option>
            <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
            <option value="Shipping">ƒêang giao</option>
            <option value="Delivered">ƒê√£ giao</option>
        </select>
    </div>
</div>

<div id="ordersContainer"></div>

<script>
let allOrders = [];
let currentUser = null;

// Ki·ªÉm tra user ƒëƒÉng nh·∫≠p
function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user || user.type !== 'staff') {
        window.location.href = '/web/login/';
        return null;
    }
    currentUser = user;
    return user;
}

// T·∫£i danh s√°ch ƒë∆°n h√†ng
async function loadOrders() {
    const user = checkAuth();
    if (!user) return;
    
    try {
        const response = await fetch('/api/orders/');
        const data = await response.json();
        
        if (data.success) {
            allOrders = data.orders;
            renderOrders(allOrders);
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Load orders error:', error);
    }
}

// Filter orders by status
function filterOrders() {
    const status = document.getElementById('statusFilter').value;
    if (status === '') {
        renderOrders(allOrders);
    } else {
        const filtered = allOrders.filter(order => order.status === status);
        renderOrders(filtered);
    }
}

// Render danh s√°ch ƒë∆°n h√†ng
function renderOrders(orders) {
    const container = document.getElementById('ordersContainer');
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.
            </div>
        `;
        return;
    }
    
    const statusColors = {
        'Delivered': { bg: '#d4edda', text: '#155724' },
        'Pending': { bg: '#fff3cd', text: '#856404' },
        'Shipping': { bg: '#d1ecf1', text: '#0c5460' }
    };
    
    container.innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>M√£ ƒë∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>Nh√¢n vi√™n</th>
                        <th>Ng√†y ƒë·∫∑t</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    ${orders.map(order => {
                        const colors = statusColors[order.status] || { bg: '#d1ecf1', text: '#0c5460' };
                        const date = new Date(order.order_date);
                        const formattedDate = date.toLocaleDateString('vi-VN');
                        
                        return `
                            <tr>
                                <td><strong>#${order.id}</strong></td>
                                <td>${order.customer_name}</td>
                                <td>${order.staff_name}</td>
                                <td>${formattedDate}</td>
                                <td><strong>$${order.total_price}</strong></td>
                                <td>
                                    <span style="padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.9rem;
                                                 background: ${colors.bg}; color: ${colors.text};">
                                        ${order.status}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <a href="/web/orders/${order.id}/" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                                            üëÅÔ∏è Xem
                                        </a>
                                        ${order.status !== 'Delivered' ? `
                                            <select id="status_${order.id}" 
                                                    style="padding: 0.3rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                                    onchange="updateStatus(${order.id})">
                                                <option value="">-- C·∫≠p nh·∫≠t --</option>
                                                ${order.status === 'Pending' ? '<option value="Shipping">‚Üí ƒêang giao</option>' : ''}
                                                ${order.status === 'Shipping' ? '<option value="Delivered">‚Üí ƒê√£ giao</option>' : ''}
                                            </select>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
async function updateStatus(orderId) {
    const user = checkAuth();
    if (!user) return;
    
    const selectElement = document.getElementById(`status_${orderId}`);
    const newStatus = selectElement.value;
    
    if (!newStatus) return;
    
    try {
        const response = await fetch(`/api/orders/${orderId}/status/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng #${orderId}!`, 'success');
            loadOrders(); // Reload orders
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t!', 'danger');
        }
    } catch (error) {
        showAlert('C√≥ l·ªói x·∫£y ra!', 'danger');
        console.error('Update status error:', error);
    }
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => { alertContainer.innerHTML = ''; }, 3000);
}

// Kh·ªüi t·∫°o
document.getElementById('statusFilter').addEventListener('change', filterOrders);
checkAuth();
loadOrders();
</script>
{% endblock %}
